<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Algo Trading Dashboard</title>
    
    <!-- CSS Libraries -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #00ff88;
            --secondary-color: #ff4444;
            --background-dark: #1a1a1a;
            --card-background: #2d2d2d;
            --text-primary: #f7eeee;
            --text-secondary: #cccccc;
            --border-color: #ece7e7;
        }
        body {
            background-color: var(--background-dark);
            color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
        }

        .navbar {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            box-shadow: 0 2px 20px rgba(0, 255, 136, 0.3);
        }

        .card {
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 255, 136, 0.2);
        }

        .metric-card {
            text-align: center;
            padding: 1.5rem;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .metric-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .positive { color: var(--primary-color); }
        .negative { color: var(--secondary-color); }
        .neutral { color: #ffa500; }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-running { background-color: var(--primary-color); animation: pulse 2s infinite; }
        .status-stopped { background-color: var(--secondary-color); }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 255, 136, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 255, 136, 0); }
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), #00cc6a);
            border: none;
            border-radius: 25px;
            padding: 0.5rem 1.5rem;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--secondary-color), #cc1111);
            border: none;
            border-radius: 25px;
            padding: 0.5rem 1.5rem;
        }

        .table-dark {
            background-color: var(--card-background);
            border-radius: 10px;
            overflow: hidden;
        }

        .trade-row {
            transition: background-color 0.3s ease;
        }

        .trade-row:hover {
            background-color: rgba(0, 255, 136, 0.1);
        }

        .chart-container {
            height: 400px;
            border-radius: 15px;
            overflow: hidden;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .alert {
            border-radius: 10px;
            border: none;
        }

        .alert-success {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.2), rgba(0, 204, 106, 0.2));
            color: var(--primary-color);
        }

        .alert-danger {
            background: linear-gradient(135deg, rgba(255, 68, 68, 0.2), rgba(204, 17, 17, 0.2));
            color: var(--secondary-color);
        }

        .position-card {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(0, 204, 106, 0.1));
            border: 2px solid rgba(0, 255, 136, 0.3);
        }

        .footer {
            margin-top: 3rem;
            padding: 2rem 0;
            border-top: 1px solid var(--border-color);
            text-align: center;
            color: var(--text-secondary);
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .metric-value {
                font-size: 1.5rem;
            }
            .chart-container {
                height: 300px;
            }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--background-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #00cc6a;
        }
              /* Add this to ensure all text is visible */
        body, p, span, div, td, th, h1, h2, h3, h4, h5, h6 {
            color: #ffffff !important;
        }

        .text-muted {
            color: #cccccc !important;
        }

        .table-dark td, .table-dark th {
            color: #ffffff !important;
        }
      
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#">
                <i class="fas fa-robot me-2"></i>
                AI Algo Trading Dashboard
            </a>
            
            <div class="navbar-nav ms-auto">
                <div class="nav-item me-3">
                    <span class="status-indicator" id="systemStatus"></span>
                    <span id="statusText">Initializing...</span>
                </div>
                
                <button class="btn btn-primary me-2" onclick="startSystem()">
                    <i class="fas fa-play me-1"></i>Start
                </button>
                <button class="btn btn-danger me-2" onclick="stopSystem()">
                    <i class="fas fa-stop me-1"></i>Stop
                </button>
                <button class="btn btn-outline-light" onclick="exportTrades()">
                    <i class="fas fa-download me-1"></i>Export
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- System Alerts -->
        <div id="alertContainer"></div>

        <!-- Key Metrics Row -->
        <div class="row mb-4">
            <div class="col-md-2 col-sm-6 mb-3">
                <div class="card metric-card animate__animated animate__fadeInUp">
                    <div class="metric-value" id="currentCapital">₹0</div>
                    <div class="metric-label">Current Capital</div>
                </div>
            </div>
            <div class="col-md-2 col-sm-6 mb-3">
                <div class="card metric-card animate__animated animate__fadeInUp animate__delay-1s">
                    <div class="metric-value" id="totalPnL">₹0</div>
                    <div class="metric-label">Total P&L</div>
                </div>
            </div>
            <div class="col-md-2 col-sm-6 mb-3">
                <div class="card metric-card animate__animated animate__fadeInUp animate__delay-2s">
                    <div class="metric-value" id="totalTrades">0</div>
                    <div class="metric-label">Total Trades</div>
                </div>
            </div>
            <div class="col-md-2 col-sm-6 mb-3">
                <div class="card metric-card animate__animated animate__fadeInUp animate__delay-3s">
                    <div class="metric-value" id="winRate">0%</div>
                    <div class="metric-label">Win Rate</div>
                </div>
            </div>
            <div class="col-md-2 col-sm-6 mb-3">
                <div class="card metric-card animate__animated animate__fadeInUp animate__delay-4s">
                    <div class="metric-value" id="openPositions">0</div>
                    <div class="metric-label">Open Positions</div>
                </div>
            </div>
            <div class="col-md-2 col-sm-6 mb-3">
                <div class="card metric-card animate__animated animate__fadeInUp animate__delay-5s">
                    <div class="metric-value" id="currentPrice">₹0</div>
                    <div class="metric-label">Nifty Price</div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-lg-8 mb-3">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>
                            Performance Overview
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="performanceChart" class="chart-container"></div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 mb-3">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chess me-2"></i>
                            Strategy Performance
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="strategyChart" class="chart-container"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Open Positions -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-clipboard-list me-2"></i>
                            Open Positions
                            <span class="badge bg-primary ms-2" id="positionCount">0</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="openPositionsContainer">
                            <div class="text-center text-muted">
                                <i class="fas fa-inbox fa-3x mb-3"></i>
                                <p>No open positions</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Trades -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-history me-2"></i>
                            Recent Trades
                        </h5>
                        <button class="btn btn-outline-light btn-sm" onclick="refreshTrades()">
                            <i class="fas fa-refresh me-1"></i>Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-dark table-hover">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Symbol</th>
                                        <th>Strategy</th>
                                        <th>Type</th>
                                        <th>Entry ₹</th>
                                        <th>Exit ₹</th>
                                        <th>P&L ₹</th>
                                        <th>Duration</th>
                                    </tr>
                                </thead>
                                <tbody id="tradesTableBody">
                                    <tr>
                                        <td colspan="8" class="text-center text-muted">
                                            <div class="loading-spinner me-2"></div>
                                            Loading trades...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Strategy Statistics -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-cog me-2"></i>
                            Strategy Statistics
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="strategyStatsContainer">
                            <div class="text-center text-muted">
                                <div class="loading-spinner me-2"></div>
                                Loading strategy data...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <div class="container">
            <p>&copy; 2024 AI Algo Trading Platform. Built for paper trading and educational purposes.</p>
            <p>Last updated: <span id="lastUpdate">Never</span></p>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    
    <script>
        // Global variables
        let socket;
        let systemRunning = false;
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeWebSocket();
            loadInitialData();
            setInterval(updateData, 5000); // Update every 5 seconds
        });

        // WebSocket connection
        function initializeWebSocket() {
            socket = io();
            
            socket.on('connect', function() {
                console.log('Connected to server');
                showAlert('Connected to trading system', 'success');
            });
            
            socket.on('disconnect', function() {
                console.log('Disconnected from server');
                showAlert('Disconnected from trading system', 'danger');
                updateSystemStatus(false);
            });
            
            socket.on('status_update', function(data) {
                updateDashboard(data);
            });
        }

        // Load initial data
        function loadInitialData() {
            updateData();
            loadTrades();
            loadPerformanceData();
        }

        // Update dashboard with real-time data
        function updateDashboard(data) {
            if (!data) return;
            
            systemRunning = data.is_running || false;
            updateSystemStatus(systemRunning);
            
            // Update metrics
            document.getElementById('currentCapital').textContent = formatCurrency(data.current_capital || 0);
            
            const totalPnL = data.total_pnl || 0;
            const pnlElement = document.getElementById('totalPnL');
            pnlElement.textContent = formatCurrency(totalPnL);
            pnlElement.className = `metric-value ${totalPnL >= 0 ? 'positive' : 'negative'}`;
            
            document.getElementById('totalTrades').textContent = data.total_trades || 0;
            document.getElementById('winRate').textContent = `${(data.win_rate || 0).toFixed(1)}%`;
            document.getElementById('openPositions').textContent = data.open_positions || 0;
            document.getElementById('currentPrice').textContent = formatCurrency(data.current_price || 0);
            
            // Update position count badge
            document.getElementById('positionCount').textContent = data.open_positions || 0;
            
            // Update open positions
            updateOpenPositions(data.positions || []);
            
            // Update last update time
            if (data.last_update) {
                document.getElementById('lastUpdate').textContent = new Date(data.last_update).toLocaleString();
            }
        }

        // Update system status indicator
        function updateSystemStatus(running) {
            const statusIndicator = document.getElementById('systemStatus');
            const statusText = document.getElementById('statusText');
            
            if (running) {
                statusIndicator.className = 'status-indicator status-running';
                statusText.textContent = 'System Running';
                statusText.className = 'positive';
            } else {
                statusIndicator.className = 'status-indicator status-stopped';
                statusText.textContent = 'System Stopped';
                statusText.className = 'negative';
            }
        }

        // Update open positions display
        function updateOpenPositions(positions) {
            const container = document.getElementById('openPositionsContainer');
            
            if (!positions || positions.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p>No open positions</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="row">';
            positions.forEach(position => {
                const pnlClass = position.unrealized_pnl >= 0 ? 'positive' : 'negative';
                html += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card position-card">
                            <div class="card-body">
                                <h6 class="card-title">${position.symbol}</h6>
                                <div class="row text-center">
                                    <div class="col-4">
                                        <small class="text-muted">Entry</small><br>
                                        <strong>₹${position.entry_price.toFixed(2)}</strong>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted">Current</small><br>
                                        <strong>₹${position.current_price.toFixed(2)}</strong>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted">P&L</small><br>
                                        <strong class="${pnlClass}">₹${position.unrealized_pnl.toFixed(2)}</strong>
                                    </div>
                                </div>
                                <div class="mt-2 text-center">
                                    <small class="text-muted">
                                        ${position.strategy} • ${position.holding_minutes.toFixed(0)} min
                                        ${position.trailing_stop_active ? ' • <i class="fas fa-chart-line text-warning" title="Trailing Stop Active"></i>' : ''}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        // Fetch and update data
        function updateData() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Status error:', data.error);
                        updateSystemStatus(false);
                    } else {
                        updateDashboard(data);
                    }
                })
                .catch(error => {
                    console.error('Error fetching status:', error);
                    updateSystemStatus(false);
                });
        }

        // Load trades data
        function loadTrades() {
            fetch('/api/trades?limit=50')
                .then(response => response.json())
                .then(data => {
                    if (data.trades) {
                        updateTradesTable(data.trades);
                    }
                })
                .catch(error => console.error('Error loading trades:', error));
        }

        // Update trades table
        function updateTradesTable(trades) {
            const tbody = document.getElementById('tradesTableBody');
            
            if (!trades || trades.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted">No trades found</td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            trades.slice(0, 20).forEach(trade => {
                const pnlClass = (trade.pnl || 0) >= 0 ? 'positive' : 'negative';
                const entryTime = new Date(trade.entry_timestamp).toLocaleString();
                
                html += `
                    <tr class="trade-row">
                        <td>${entryTime}</td>
                        <td>${trade.symbol || 'N/A'}</td>
                        <td><span class="badge bg-secondary">${trade.strategy || 'N/A'}</span></td>
                        <td><span class="badge ${trade.option_type === 'CE' ? 'bg-success' : 'bg-danger'}">${trade.option_type || 'N/A'}</span></td>
                        <td>₹${(trade.entry_price || 0).toFixed(2)}</td>
                        <td>₹${(trade.exit_price || 0).toFixed(2)}</td>
                        <td><span class="${pnlClass}">₹${(trade.pnl || 0).toFixed(2)}</span></td>
                        <td>${(trade.holding_minutes || 0).toFixed(0)} min</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        // Load performance data and charts
        function loadPerformanceData() {
            fetch('/api/performance')
                .then(response => response.json())
                .then(data => {
                    if (data.performance_chart) {
                        const chartData = JSON.parse(data.performance_chart);
                        Plotly.newPlot('performanceChart', chartData.data, chartData.layout, {responsive: true});
                    }
                    
                    if (data.strategy_chart) {
                        const chartData = JSON.parse(data.strategy_chart);
                        Plotly.newPlot('strategyChart', chartData.data, chartData.layout, {responsive: true});
                    }
                })
                .catch(error => console.error('Error loading performance data:', error));
                
            // Load strategy statistics
            fetch('/api/strategies')
                .then(response => response.json())
                .then(data => {
                    if (data.strategies) {
                        updateStrategyStats(data.strategies);
                    }
                })
                .catch(error => console.error('Error loading strategy stats:', error));
        }

        // Update strategy statistics
        function updateStrategyStats(strategies) {
            const container = document.getElementById('strategyStatsContainer');
            
            if (!strategies || strategies.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">No strategy data available</div>';
                return;
            }
            
            let html = '<div class="row">';
            strategies.forEach(strategy => {
                const pnlClass = (strategy.total_pnl || 0) >= 0 ? 'positive' : 'negative';
                html += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6 class="card-title">${strategy.strategy}</h6>
                                <div class="metric-value ${pnlClass}">₹${(strategy.total_pnl || 0).toFixed(2)}</div>
                                <div class="row mt-2">
                                    <div class="col-4">
                                        <small class="text-muted">Trades</small><br>
                                        <strong>${strategy.total_trades || 0}</strong>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted">Win Rate</small><br>
                                        <strong>${(strategy.win_rate || 0).toFixed(1)}%</strong>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted">Avg P&L</small><br>
                                        <strong>₹${(strategy.avg_pnl || 0).toFixed(2)}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        // System control functions
        function startSystem() {
            showAlert('Starting trading system...', 'info');
            fetch('/api/control/start')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showAlert(data.message, 'success');
                        setTimeout(updateData, 2000);
                    } else {
                        showAlert(data.message, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error starting system:', error);
                    showAlert('Error starting system', 'danger');
                });
        }

        function stopSystem() {
            showAlert('Stopping trading system...', 'info');
            fetch('/api/control/stop')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showAlert(data.message, 'success');
                        setTimeout(updateData, 2000);
                    } else {
                        showAlert(data.message, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error stopping system:', error);
                    showAlert('Error stopping system', 'danger');
                });
        }

        function exportTrades() {
            showAlert('Preparing trade export...', 'info');
            window.open('/api/export', '_blank');
        }

        function refreshTrades() {
            loadTrades();
            loadPerformanceData();
            showAlert('Data refreshed', 'success');
        }

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            }).format(amount);
        }

        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alertId = 'alert-' + Date.now();
            
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show animate__animated animate__fadeInDown" role="alert" id="${alertId}">
                    <i class="fas fa-${getAlertIcon(type)} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', alertHtml);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) {
                    alert.classList.add('animate__fadeOutUp');
                    setTimeout(() => alert.remove(), 500);
                }
            }, 5000);
        }

        function getAlertIcon(type) {
            switch(type) {
                case 'success': return 'check-circle';
                case 'danger': return 'exclamation-triangle';
                case 'warning': return 'exclamation-circle';
                case 'info': return 'info-circle';
                default: return 'info-circle';
            }
        }

        // Handle window resize for charts
        window.addEventListener('resize', function() {
            if (document.getElementById('performanceChart')) {
                Plotly.Plots.resize('performanceChart');
            }
            if (document.getElementById('strategyChart')) {
                Plotly.Plots.resize('strategyChart');
            }
        });

        // Handle page visibility for performance optimization
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // Page is hidden, reduce update frequency
                console.log('Dashboard hidden, reducing update frequency');
            } else {
                // Page is visible, resume normal updates
                console.log('Dashboard visible, resuming normal updates');
                updateData();
            }
        });

        // Initialize tooltips (if using Bootstrap tooltips)
        document.addEventListener('DOMContentLoaded', function() {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });
    </script>
</body>
</html>