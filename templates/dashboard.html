<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI NIFTY50 Options Trading Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.27.0/plotly.min.js"></script>
    <style>
        body {
            background: #0f172a;
            color: #f8fafc;
            font-family: 'Inter', sans-serif;
        }
        .navbar {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            box-shadow: 0 10px 30px rgba(37, 99, 235, 0.35);
        }
        .card {
            background: rgba(15, 23, 42, 0.75);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 18px;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.45);
        }
        .card h5, .card h6 {
            color: #e2e8f0;
        }
        .metric-value {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        .metric-label {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #94a3b8;
        }
        .tab-content {
            margin-top: 1.5rem;
        }
        .nav-tabs .nav-link {
            border: none;
            color: #cbd5f5;
            font-weight: 500;
        }
        .nav-tabs .nav-link.active {
            color: #0ea5e9;
            background: rgba(14, 165, 233, 0.12);
            border-radius: 12px;
        }
        table.table-dark {
            background: rgba(15, 23, 42, 0.7);
        }
        .status-chip {
            padding: 6px 16px;
            border-radius: 50px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .status-running {
            background: rgba(34, 197, 94, 0.15);
            color: #4ade80;
        }
        .status-stopped {
            background: rgba(248, 113, 113, 0.15);
            color: #f87171;
        }
        .form-control, .form-select {
            background: rgba(15, 23, 42, 0.9);
            border-color: rgba(148, 163, 184, 0.3);
            color: #e2e8f0;
        }
        .form-control:focus, .form-select:focus {
            background: rgba(15, 23, 42, 0.95);
            color: #f8fafc;
            border-color: #38bdf8;
            box-shadow: none;
        }
        .badge-custom {
            background: rgba(59, 130, 246, 0.18);
            color: #60a5fa;
            border-radius: 50px;
            padding: 6px 12px;
        }
        .list-group-item {
            background: rgba(15, 23, 42, 0.6);
            color: #e2e8f0;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand fw-semibold" href="#"><i class="fa-solid fa-chart-line me-2"></i>AI Options Trading Suite</a>
        <div>
            <button id="startEngineBtn" class="btn btn-success me-2"><i class="fa-solid fa-play"></i> Start Engine</button>
            <button id="stopEngineBtn" class="btn btn-danger"><i class="fa-solid fa-stop"></i> Stop Engine</button>
        </div>
    </div>
</nav>

<div class="container py-4">
    <div class="d-flex flex-wrap align-items-center justify-content-between mb-4">
        <div>
            <div id="engineStatus" class="status-chip status-stopped">
                <span class="indicator"></span>Engine Offline
            </div>
            <div class="text-muted small" id="lastUpdate">Last update: --</div>
        </div>
        <div class="text-end">
            <div class="metric-label">Active Strategies</div>
            <div id="activeStrategiesList" class="badge-custom"></div>
        </div>
    </div>

    <div class="row g-4 mb-2">
        <div class="col-md-3">
            <div class="card p-3 h-100">
                <div class="metric-label">Current Capital</div>
                <div class="metric-value" id="currentCapital">₹0</div>
                <small class="text-muted">Allocated capital in live engine</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 h-100">
                <div class="metric-label">Realized P&L</div>
                <div class="metric-value" id="totalPnL">₹0</div>
                <small class="text-muted">Net profit across closed positions</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 h-100">
                <div class="metric-label">Win Rate</div>
                <div class="metric-value" id="winRate">0%</div>
                <small class="text-muted">Winning trades as % of total</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 h-100">
                <div class="metric-label">Open Positions</div>
                <div class="metric-value" id="openPositions">0</div>
                <small class="text-muted">Live option positions being tracked</small>
            </div>
        </div>
    </div>

    <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">Overview</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="trades-tab" data-bs-toggle="tab" data-bs-target="#trades" type="button" role="tab">Trades</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="strategies-tab" data-bs-toggle="tab" data-bs-target="#strategies" type="button" role="tab">Strategies</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="backtest-tab" data-bs-toggle="tab" data-bs-target="#backtest" type="button" role="tab">Backtesting</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="config-tab" data-bs-toggle="tab" data-bs-target="#configuration" type="button" role="tab">Configuration</button>
        </li>
    </ul>

    <div class="tab-content" id="dashboardTabsContent">
        <div class="tab-pane fade show active" id="overview" role="tabpanel">
            <div class="row g-4 mt-1">
                <div class="col-lg-6">
                    <div class="card p-4">
                        <h5 class="mb-3"><i class="fa-solid fa-chart-area me-2 text-info"></i>Equity Curve</h5>
                        <div id="performanceChart" style="height:360px"></div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card p-4 mb-4">
                        <h5 class="mb-3"><i class="fa-solid fa-clock-rotate-left me-2 text-warning"></i>Hourly Alpha</h5>
                        <div id="hourlyChart" style="height:260px"></div>
                    </div>
                    <div class="card p-4">
                        <h6 class="text-uppercase text-muted">Daily Summary</h6>
                        <div class="row mt-3">
                            <div class="col-6">
                                <div class="metric-label">Trades Today</div>
                                <div class="metric-value" id="dailyTradeCount">0</div>
                            </div>
                            <div class="col-6">
                                <div class="metric-label">Unrealized P&L</div>
                                <div class="metric-value" id="unrealizedPnL">₹0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="trades" role="tabpanel">
            <div class="card p-3 mt-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="fa-solid fa-list me-2 text-info"></i>Recent Trades</h5>
                    <button class="btn btn-outline-light btn-sm" id="refreshTradesBtn"><i class="fa-solid fa-rotate"></i> Refresh</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-dark table-striped align-middle">
                        <thead>
                            <tr>
                                <th>Entry</th>
                                <th>Exit</th>
                                <th>Symbol</th>
                                <th>Strategy</th>
                                <th>Lots</th>
                                <th>Entry</th>
                                <th>Exit</th>
                                <th>P&amp;L</th>
                                <th>Reason</th>
                            </tr>
                        </thead>
                        <tbody id="tradesTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="strategies" role="tabpanel">
            <div class="row g-4 mt-3">
                <div class="col-lg-6">
                    <div class="card p-4">
                        <h5 class="mb-3"><i class="fa-solid fa-layer-group me-2 text-info"></i>Strategy Performance</h5>
                        <div id="strategyChart" style="height:320px"></div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card p-4">
                        <h5 class="mb-3">Metrics</h5>
                        <div class="table-responsive">
                            <table class="table table-dark table-sm mb-0">
                                <thead>
                                    <tr>
                                        <th>Strategy</th>
                                        <th>Trades</th>
                                        <th>Wins</th>
                                        <th>Win %</th>
                                        <th>Total P&amp;L</th>
                                    </tr>
                                </thead>
                                <tbody id="strategyTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="backtest" role="tabpanel">
            <div class="row g-4 mt-3">
                <div class="col-lg-4">
                    <div class="card p-4 h-100">
                        <h5 class="mb-3"><i class="fa-solid fa-microscope me-2 text-info"></i>Run Backtest</h5>
                        <form id="backtestForm" class="needs-validation" novalidate>
                            <div class="mb-3">
                                <label class="form-label">Symbol</label>
                                <input type="text" class="form-control" id="backtestSymbol" value="^NSEI" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Interval</label>
                                <select id="backtestInterval" class="form-select">
                                    <option value="1m" selected>1 minute</option>
                                    <option value="5m">5 minute</option>
                                    <option value="15m">15 minute</option>
                                    <option value="30m">30 minute</option>
                                    <option value="60m">60 minute</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Lookback (days)</label>
                                <input type="number" class="form-control" id="backtestLookback" value="5" min="1" max="30">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Strategies</label>
                                <select multiple class="form-select" id="backtestStrategies"></select>
                                <small class="text-muted">Leave empty to use active strategies</small>
                            </div>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="backtestAutoApply" checked>
                                <label class="form-check-label" for="backtestAutoApply">Apply best strategy to live engine</label>
                            </div>
                            <button class="btn btn-info w-100" type="submit"><i class="fa-solid fa-vial-circle-check me-2"></i>Run Backtest</button>
                        </form>
                        <div id="backtestAlert" class="alert mt-3 d-none"></div>
                    </div>
                </div>
                <div class="col-lg-8">
                    <div class="card p-4 mb-4">
                        <h5 class="mb-3">Backtest Results</h5>
                        <div class="table-responsive">
                            <table class="table table-dark table-striped align-middle">
                                <thead>
                                    <tr>
                                        <th>Strategy</th>
                                        <th>Trades</th>
                                        <th>Win %</th>
                                        <th>Total P&amp;L</th>
                                        <th>Avg Trade</th>
                                        <th>Sharpe</th>
                                        <th>Max DD</th>
                                    </tr>
                                </thead>
                                <tbody id="backtestResultsBody"></tbody>
                            </table>
                        </div>
                        <div class="small text-muted" id="backtestSummary"></div>
                    </div>
                    <div class="card p-4">
                        <h5 class="mb-3">Best Strategy Equity Curve</h5>
                        <div id="backtestEquityChart" style="height:300px"></div>
                        <div class="mt-3">
                            <h6 class="text-muted">Notes</h6>
                            <ul id="backtestNotes" class="mb-0"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="configuration" role="tabpanel">
            <div class="row g-4 mt-3">
                <div class="col-lg-5">
                    <div class="card p-4">
                        <h5 class="mb-3"><i class="fa-solid fa-sliders me-2 text-info"></i>Trading Parameters</h5>
                        <form id="configForm">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Total Capital (₹)</label>
                                    <input type="number" class="form-control" id="totalCapital" min="0">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Risk / Trade (%)</label>
                                    <input type="number" class="form-control" id="riskPerTrade" step="0.01" min="0" max="1">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Max Trades / Day</label>
                                    <input type="number" class="form-control" id="maxTradesPerDay" min="1">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Max Open Positions</label>
                                    <input type="number" class="form-control" id="maxOpenPositions" min="1">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Cooldown (minutes)</label>
                                    <input type="number" class="form-control" id="cooldownMinutes" min="0">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Confidence Threshold</label>
                                    <input type="number" class="form-control" id="entryConfidence" min="0" max="100">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Fixed Risk (₹)</label>
                                    <input type="number" class="form-control" id="fixedRisk" min="0">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Target Trigger (₹)</label>
                                    <input type="number" class="form-control" id="targetTrigger" min="0">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Trail %</label>
                                    <input type="number" class="form-control" id="trailPct" step="0.01" min="0">
                                </div>
                            </div>
                            <div class="mt-4">
                                <label class="form-label">Active Strategies</label>
                                <select multiple class="form-select" id="activeStrategies"></select>
                            </div>
                            <div id="configAlert" class="alert mt-3 d-none"></div>
                            <button class="btn btn-info mt-3" type="submit"><i class="fa-solid fa-floppy-disk me-2"></i>Save Configuration</button>
                        </form>
                    </div>
                </div>
                <div class="col-lg-7">
                    <div class="card p-4 h-100">
                        <h5 class="mb-3"><i class="fa-solid fa-gears me-2 text-info"></i>Strategy Parameters</h5>
                        <div id="strategyConfigContainer" class="row g-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
<script>
(function() {
    const statusEls = {
        engineStatus: document.getElementById('engineStatus'),
        lastUpdate: document.getElementById('lastUpdate'),
        currentCapital: document.getElementById('currentCapital'),
        totalPnL: document.getElementById('totalPnL'),
        winRate: document.getElementById('winRate'),
        openPositions: document.getElementById('openPositions'),
        unrealizedPnL: document.getElementById('unrealizedPnL'),
        dailyTradeCount: document.getElementById('dailyTradeCount'),
        activeStrategies: document.getElementById('activeStrategiesList'),
    };

    let charts = {
        performance: null,
        hourly: null,
        strategy: null,
        backtestEquity: null,
    };

    function formatCurrency(value) {
        if (value === null || value === undefined || isNaN(value)) return '₹0';
        return '₹' + Number(value).toLocaleString('en-IN', {maximumFractionDigits: 2});
    }

    function formatPercent(value) {
        if (value === null || value === undefined || isNaN(value)) return '0%';
        return Number(value).toFixed(2) + '%';
    }

    function setStatus(status) {
        const running = !!status.is_running;
        statusEls.engineStatus.classList.toggle('status-running', running);
        statusEls.engineStatus.classList.toggle('status-stopped', !running);
        statusEls.engineStatus.innerHTML = running ? '<i class="fa-solid fa-circle-play"></i> Engine Running' : '<i class="fa-solid fa-circle-stop"></i> Engine Stopped';
        statusEls.lastUpdate.textContent = 'Last update: ' + (status.last_update || new Date().toISOString());
        statusEls.currentCapital.textContent = formatCurrency(status.current_capital);
        statusEls.totalPnL.textContent = formatCurrency(status.total_pnl);
        statusEls.winRate.textContent = formatPercent(status.win_rate);
        statusEls.openPositions.textContent = status.open_positions || 0;
        statusEls.unrealizedPnL.textContent = formatCurrency(status.unrealized_pnl);
        statusEls.dailyTradeCount.textContent = status.daily_trade_count || 0;
        const strategies = status.active_strategies || [];
        statusEls.activeStrategies.textContent = strategies.length ? strategies.join(', ') : 'None';
    }

    function loadStatus() {
        fetch('/api/status')
            .then(res => res.json())
            .then(data => setStatus(data))
            .catch(err => console.error('Status load failed', err));
    }

    function loadPerformance() {
        fetch('/api/performance')
            .then(res => res.json())
            .then(data => {
                const perf = data.performance_chart ? JSON.parse(data.performance_chart) : null;
                const hourly = data.hourly_chart ? JSON.parse(data.hourly_chart) : null;
                const strategy = data.strategy_chart ? JSON.parse(data.strategy_chart) : null;
                if (perf) {
                    charts.performance = Plotly.newPlot('performanceChart', perf.data, perf.layout, {responsive: true});
                }
                if (hourly) {
                    charts.hourly = Plotly.newPlot('hourlyChart', hourly.data, hourly.layout, {responsive: true});
                }
                if (strategy) {
                    charts.strategy = Plotly.newPlot('strategyChart', strategy.data, strategy.layout, {responsive: true});
                }
            })
            .catch(err => console.error('Performance load failed', err));
    }

    function loadTrades() {
        fetch('/api/trades?limit=200')
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById('tradesTableBody');
                tbody.innerHTML = '';
                (data.trades || []).forEach(trade => {
                    const row = document.createElement('tr');
                    const pnlClass = trade.pnl > 0 ? 'text-success' : (trade.pnl < 0 ? 'text-danger' : 'text-muted');
                    row.innerHTML = `
                        <td>${trade.entry_timestamp || '--'}</td>
                        <td>${trade.exit_timestamp || '--'}</td>
                        <td>${trade.symbol || ''}</td>
                        <td>${trade.strategy || ''}</td>
                        <td>${trade.qty_lots || 0}</td>
                        <td>${formatCurrency(trade.entry_price)}</td>
                        <td>${formatCurrency(trade.exit_price)}</td>
                        <td class="${pnlClass}">${formatCurrency(trade.pnl)}</td>
                        <td>${trade.reason_exit || ''}</td>`;
                    tbody.appendChild(row);
                });
            })
            .catch(err => console.error('Trades load failed', err));
    }

    function loadStrategyStats() {
        fetch('/api/strategies')
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById('strategyTableBody');
                tbody.innerHTML = '';
                (data.strategies || []).forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.strategy}</td>
                        <td>${item.total_trades}</td>
                        <td>${item.winning_trades}</td>
                        <td>${formatPercent(item.win_rate)}</td>
                        <td>${formatCurrency(item.total_pnl)}</td>`;
                    tbody.appendChild(row);
                });

                if (data.strategies && data.strategies.length) {
                    const names = data.strategies.map(s => s.strategy);
                    const pnl = data.strategies.map(s => s.total_pnl);
                    const trace = [{
                        x: names,
                        y: pnl,
                        type: 'bar',
                        marker: {color: '#38bdf8'}
                    }];
                    const layout = {
                        paper_bgcolor: 'rgba(0,0,0,0)',
                        plot_bgcolor: 'rgba(0,0,0,0)',
                        font: {color: '#e2e8f0'},
                        margin: {t: 30}
                    };
                    charts.strategy = Plotly.newPlot('strategyChart', trace, layout, {responsive: true});
                }
            })
            .catch(err => console.error('Strategy stats failed', err));
    }

    function populateStrategyOptions(options, active) {
        const select = document.getElementById('activeStrategies');
        const backtestSelect = document.getElementById('backtestStrategies');
        select.innerHTML = '';
        backtestSelect.innerHTML = '';
        options.forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            if (!active || active.includes(name)) {
                opt.selected = true;
            }
            select.appendChild(opt);

            const backOpt = document.createElement('option');
            backOpt.value = name;
            backOpt.textContent = name;
            backtestSelect.appendChild(backOpt);
        });
    }

    function renderStrategyConfig(params) {
        const container = document.getElementById('strategyConfigContainer');
        container.innerHTML = '';
        Object.entries(params || {}).forEach(([name, values]) => {
            const col = document.createElement('div');
            col.className = 'col-md-6';
            const card = document.createElement('div');
            card.className = 'p-3 border rounded-4 bg-dark bg-opacity-25 h-100';
            const heading = document.createElement('h6');
            heading.className = 'text-info';
            heading.textContent = name;
            card.appendChild(heading);
            Object.entries(values).forEach(([key, value]) => {
                const group = document.createElement('div');
                group.className = 'mb-2';
                const label = document.createElement('label');
                label.className = 'form-label small text-muted';
                label.textContent = key.replace(/_/g, ' ');
                const input = document.createElement('input');
                input.type = 'number';
                input.step = 'any';
                input.className = 'form-control form-control-sm';
                input.dataset.strategy = name;
                input.dataset.param = key;
                input.value = value;
                group.appendChild(label);
                group.appendChild(input);
                card.appendChild(group);
            });
            col.appendChild(card);
            container.appendChild(col);
        });
    }

    function renderConfig(config) {
        if (!config) return;
        document.getElementById('totalCapital').value = config.trading.total_capital;
        document.getElementById('riskPerTrade').value = config.trading.risk_per_trade;
        document.getElementById('maxTradesPerDay').value = config.trading.max_trades_per_day;
        document.getElementById('maxOpenPositions').value = config.trading.max_open_positions;
        document.getElementById('cooldownMinutes').value = config.trading.cooldown_minutes;
        document.getElementById('entryConfidence').value = config.trading.entry_confidence_min;
        document.getElementById('fixedRisk').value = config.trading.fixed_risk_rupees;
        document.getElementById('targetTrigger').value = config.trading.target_trigger_rupees;
        document.getElementById('trailPct').value = config.trading.trail_pct;
        populateStrategyOptions(config.available_strategies || [], config.trading.active_strategies);
        renderStrategyConfig(config.strategy_params);
    }

    function loadConfig() {
        fetch('/api/config')
            .then(res => res.json())
            .then(data => {
                const conf = data.config || {};
                conf.available_strategies = data.available_strategies || [];
                renderConfig(conf);
            })
            .catch(err => console.error('Config load failed', err));
    }

    function showAlert(elementId, message, type) {
        const el = document.getElementById(elementId);
        el.className = `alert alert-${type}`;
        el.textContent = message;
        el.classList.remove('d-none');
        setTimeout(() => el.classList.add('d-none'), 4000);
    }

    document.getElementById('configForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const active = Array.from(document.getElementById('activeStrategies').selectedOptions).map(o => o.value);
        const payload = {
            trading: {
                total_capital: Number(document.getElementById('totalCapital').value),
                risk_per_trade: Number(document.getElementById('riskPerTrade').value),
                max_trades_per_day: Number(document.getElementById('maxTradesPerDay').value),
                max_open_positions: Number(document.getElementById('maxOpenPositions').value),
                cooldown_minutes: Number(document.getElementById('cooldownMinutes').value),
                entry_confidence_min: Number(document.getElementById('entryConfidence').value),
                fixed_risk_rupees: Number(document.getElementById('fixedRisk').value),
                target_trigger_rupees: Number(document.getElementById('targetTrigger').value),
                trail_pct: Number(document.getElementById('trailPct').value),
            },
            strategy_params: {},
            active_strategies: active
        };
        document.querySelectorAll('#strategyConfigContainer [data-strategy]').forEach(input => {
            const strategy = input.dataset.strategy;
            const param = input.dataset.param;
            payload.strategy_params[strategy] = payload.strategy_params[strategy] || {};
            payload.strategy_params[strategy][param] = Number(input.value);
        });
        fetch('/api/config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        }).then(res => res.json())
          .then(resp => {
            if (resp.status === 'success') {
                showAlert('configAlert', 'Configuration saved successfully', 'success');
                loadStatus();
            } else {
                showAlert('configAlert', resp.message || 'No changes applied', 'warning');
            }
          })
          .catch(err => {
            console.error(err);
            showAlert('configAlert', 'Failed to update configuration', 'danger');
          });
    });

    document.getElementById('backtestForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const payload = {
            symbol: document.getElementById('backtestSymbol').value,
            interval: document.getElementById('backtestInterval').value,
            lookback_days: Number(document.getElementById('backtestLookback').value),
            strategies: Array.from(document.getElementById('backtestStrategies').selectedOptions).map(o => o.value),
            auto_apply_best: document.getElementById('backtestAutoApply').checked
        };
        fetch('/api/backtest', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        }).then(res => res.json())
          .then(resp => {
            if (resp.status === 'success') {
                showAlert('backtestAlert', 'Backtest completed', 'success');
                renderBacktest(resp.result);
                loadStatus();
            } else {
                showAlert('backtestAlert', resp.message || 'Backtest failed', 'danger');
            }
          })
          .catch(err => {
            console.error(err);
            showAlert('backtestAlert', 'Backtest execution failed', 'danger');
          });
    });

    function renderBacktest(result) {
        const tbody = document.getElementById('backtestResultsBody');
        const summary = document.getElementById('backtestSummary');
        const notes = document.getElementById('backtestNotes');
        tbody.innerHTML = '';
        summary.textContent = '';
        notes.innerHTML = '';
        if (!result || !result.strategies || !result.strategies.length) {
            summary.textContent = 'No trades generated in selected window.';
            return;
        }
        const best = (result.best_strategy || {}).name;
        result.strategies.forEach(item => {
            const row = document.createElement('tr');
            if (item.name === best) {
                row.classList.add('table-success');
            }
            row.innerHTML = `
                <td>${item.name}</td>
                <td>${item.total_trades}</td>
                <td>${formatPercent(item.win_rate)}</td>
                <td>${formatCurrency(item.total_pnl)}</td>
                <td>${formatCurrency(item.avg_trade_pnl)}</td>
                <td>${item.sharpe ? item.sharpe.toFixed(2) : '0.00'}</td>
                <td>${formatPercent(item.max_drawdown_pct)}</td>`;
            tbody.appendChild(row);
        });
        summary.textContent = `Window ${result.start} → ${result.end} | Data points: ${result.data_points}`;
        if (result.notes && result.notes.length) {
            result.notes.forEach(note => {
                const li = document.createElement('li');
                li.textContent = note;
                notes.appendChild(li);
            });
        }
        if (result.best_strategy && result.best_strategy.equity_curve) {
            const equity = result.best_strategy.equity_curve;
            const x = equity.map(pt => pt.timestamp);
            const y = equity.map(pt => pt.equity);
            const trace = [{x, y, type: 'scatter', mode: 'lines', line: {color: '#22d3ee', width: 3}}];
            const layout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: {color: '#e2e8f0'},
                margin: {t: 30}
            };
            charts.backtestEquity = Plotly.newPlot('backtestEquityChart', trace, layout, {responsive: true});
        }
    }

    document.getElementById('refreshTradesBtn').addEventListener('click', () => loadTrades());
    document.getElementById('startEngineBtn').addEventListener('click', () => controlEngine('start'));
    document.getElementById('stopEngineBtn').addEventListener('click', () => controlEngine('stop'));

    function controlEngine(action) {
        fetch(`/api/control/${action}`)
            .then(res => res.json())
            .then(resp => {
                loadStatus();
                const type = resp.status === 'success' ? 'success' : (resp.status === 'info' ? 'warning' : 'danger');
                showAlert('configAlert', resp.message || 'Engine command executed', type);
            })
            .catch(err => console.error('Engine control failed', err));
    }

    loadStatus();
    loadPerformance();
    loadTrades();
    loadStrategyStats();
    loadConfig();

    setInterval(loadStatus, 6000);
    setInterval(loadTrades, 25000);
    setInterval(loadStrategyStats, 40000);
})();
</script>
</body>
</html>
